<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸°ìˆ™ì‚¬ ì¸ì›ë³´ê³  ì‹œìŠ¤í…œ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            border-left: 5px solid #4facfe;
        }

        .form-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
        }

        .form-group select,
        .form-group input {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .number-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .number-input button {
            width: 40px;
            height: 40px;
            border: none;
            background: #4facfe;
            color: white;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: background 0.3s;
        }

        .number-input button:hover {
            background: #3b8bfe;
        }

        .number-input input {
            width: 80px;
            text-align: center;
            margin: 0;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .individual-section {
            background: #fff5f5;
            border-left: 5px solid #ff6b6b;
        }

        .student-row {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .add-btn {
            background: #2ed573;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin: 20px 0;
        }

        .submit-btn {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            width: 100%;
            margin-top: 30px;
            transition: transform 0.3s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .dashboard-link {
            display: inline-block;
            background: #ff6b6b;
            color: white;
            text-decoration: none;
            padding: 12px 24px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .time-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-building"></i> ê¸°ìˆ™ì‚¬ ì¸ì›ë³´ê³  ì‹œìŠ¤í…œ</h1>
            <p>ë§¤ì¼ 22:00 ~ ë‹¤ìŒë‚  21:59ê¹Œì§€ ë³´ê³  ê°€ëŠ¥</p>
            <div class="time-info">
                <i class="fas fa-clock"></i> í˜„ì¬ ì‹œê°„: <span id="currentTime"></span>
            </div>
        </div>

        <div class="main-content">
            <div id="alertContainer"></div>

            <form id="reportForm">
                <!-- ê¸°ë³¸ ë³´ê³  ì •ë³´ -->
                <div class="form-section">
                    <h2><i class="fas fa-user-tie"></i> ê¸°ë³¸ ë³´ê³  ì •ë³´</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="manager">ë‹´ë‹¹ì</label>
                            <select id="manager" name="manager" required>
                                <option value="">ë‹´ë‹¹ì ì„ íƒ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="building">ë™</label>
                            <select id="building" name="building" required>
                                <option value="">ë™ ì„ íƒ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="floor">ì¸µ</label>
                            <select id="floor" name="floor" required>
                                <option value="">ì¸µ ì„ íƒ</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>ì™¸ë°•</label>
                            <div class="number-input">
                                <button type="button" onclick="decreaseValue('overnight')">-</button>
                                <input type="number" id="overnight" name="overnight" value="0" min="0">
                                <button type="button" onclick="increaseValue('overnight')">+</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>í‡´ì†Œ</label>
                            <div class="number-input">
                                <button type="button" onclick="decreaseValue('checkout')">-</button>
                                <input type="number" id="checkout" name="checkout" value="0" min="0">
                                <button type="button" onclick="increaseValue('checkout')">+</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ì´ë™ OUT (-)</label>
                            <div class="number-input">
                                <button type="button" onclick="decreaseValue('moveOut')">-</button>
                                <input type="number" id="moveOut" name="moveOut" value="0" min="0">
                                <button type="button" onclick="increaseValue('moveOut')">+</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ì´ë™ IN (+)</label>
                            <div class="number-input">
                                <button type="button" onclick="decreaseValue('moveIn')">-</button>
                                <input type="number" id="moveIn" name="moveIn" value="0" min="0">
                                <button type="button" onclick="increaseValue('moveIn')">+</button>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>í˜„ì¬ì› (ìˆ˜ë™ì…ë ¥)</label>
                            <div class="number-input">
                                <button type="button" onclick="decreaseValue('currentCount')">-</button>
                                <input type="number" id="currentCount" name="currentCount" value="0" min="0">
                                <button type="button" onclick="increaseValue('currentCount')">+</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ì™¸ì¶œ</label>
                            <div class="number-input">
                                <button type="button" onclick="decreaseValue('outing')">-</button>
                                <input type="number" id="outing" name="outing" value="0" min="0">
                                <button type="button" onclick="increaseValue('outing')">+</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ê¸°íƒ€</label>
                            <div class="number-input">
                                <button type="button" onclick="decreaseValue('etc')">-</button>
                                <input type="number" id="etc" name="etc" value="0" min="0">
                                <button type="button" onclick="increaseValue('etc')">+</button>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="memo">ê¸°íƒ€ ì‚¬í•­</label>
                            <input type="text" id="memo" name="memo" placeholder="ê¸°íƒ€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                    </div>
                </div>

                <!-- ê°œë³„ í•™ìƒ ì •ë³´ ì…ë ¥ -->
                <div class="form-section individual-section">
                    <h2><i class="fas fa-users"></i> ê°œë³„ í•™ìƒ ì •ë³´ ì…ë ¥</h2>
                    <div id="studentRows">
                        <!-- í•™ìƒ í–‰ë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë  ì˜ˆì • -->
                    </div>
                    <button type="button" class="add-btn" onclick="addStudentRow()">
                        <i class="fas fa-plus"></i> í•™ìƒ ì¶”ê°€
                    </button>
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">
                    <i class="fas fa-paper-plane"></i> ì¸ì›ë³´ê³  ì œì¶œ
                </button>
            </form>

            <a href="dashboard-standalone.html" class="dashboard-link">
                <i class="fas fa-chart-dashboard"></i> ëŒ€ì‹œë³´ë“œ ë³´ê¸°
            </a>
        </div>
    </div>

    <script>
        // CONFIG ì„¤ì • - ì—¬ê¸°ì„œ API í‚¤ì™€ ì„¤ì •ì„ ìˆ˜ì •í•˜ì„¸ìš”
        const CONFIG = {
            SHEET_ID: '1cASz2h4Dd13H6vhdKAPHOFdf5BMsFjaFledqVbzpP8I',
            SHEET_NAME: 'yulee',
            API_KEY: 'AIzaSyA1uY-EDvpxvxqyXTDwjNpS2ugYXQ3igtk', // API í‚¤ ì„¤ì • ì™„ë£Œ
            
            JANDI_WEBHOOK: 'https://wh.jandi.com/connect-api/webhook/29522216/3d9603c3b428b386c0d640758e236cb4',
            
            MANAGERS: [
                'ì´ì˜ìš´', 'ê¹€í˜œì •', 'ì´ì‹œìš°', 'ê³ ìŠ¹ì™„', 'ë‚¨ì¸ë‹¬',
                'ì¡°ì˜ê¶Œ', 'í™©ë¯¼ì² ', 'ê°•ì§€í›ˆ', 'ê¹€ê±´í¬', 'ì†¡ì¸ìˆ˜',
                'ê¹€ì˜í˜„', 'ê¹€ë¯¸ê²½', 'ìœ ë‚˜ê²½', 'ì§„ì •í˜„', 'ì›í˜„ì£¼',
                'ê¹€ì§€í˜„', 'ê¹€ì •ì•„', 'ì‹ ê·œ1', 'ì‹ ê·œ2', 'ì‹ ê·œ3',
                'ì‹ ê·œ4', 'ì‹ ê·œ5', 'ì‹ ê·œ6', 'ì‹ ê·œ7'
            ],
            
            BUILDINGS: ['A', 'B', 'C', 'D', 'E', 'F'],
            FLOORS: [1, 2, 3, 4],
            
            GENDER_BY_BUILDING: {
                'A': 'ë‚¨', 'B': 'ë‚¨', 'C': 'ë‚¨', 'F': 'ë‚¨',
                'D': 'ì—¬', 'E': 'ì—¬'
            },
            
            ROOM_RANGES: {
                'A': { '1': '101-132', '2': '201-232', '3': '301-332', '4': '401-432' },
                'B': { '1': '101-121', '2': '201-221', '3': '301-321', '4': '401-421' },
                'C': { '1': '101-132', '2': '201-232', '3': '301-332', '4': '401-432' },
                'D': { '1': '101-123', '2': '201-223', '3': '301-323', '4': '401-423' },
                'E': { '1': '101-140', '2': '201-240', '3': '301-340', '4': '401-440' },
                'F': { '1': '101-117', '2': '201-217', '3': '301-317', '4': '401-417' }
            },
            
            STATUS_TYPES: [
                'ì™¸ë°•', 'ì™¸ì¶œ', 'í‡´ì†Œ', 'ì´ë™+', 'ì´ë™-', 'ì •ìƒ', 'ê¸°íƒ€'
            ],
            
            REPORT_START_HOUR: 22,
            REPORT_END_HOUR: 21,
            REPORT_END_MINUTE: 59
        };

        // Utils í´ë˜ìŠ¤
        const Utils = {
            isValidReportTime() {
                const now = new Date();
                const hour = now.getHours();
                const minute = now.getMinutes();
                
                return hour >= CONFIG.REPORT_START_HOUR || 
                       (hour < CONFIG.REPORT_END_HOUR) || 
                       (hour === CONFIG.REPORT_END_HOUR && minute <= CONFIG.REPORT_END_MINUTE);
            },
            
            getReportPeriodId() {
                const now = new Date();
                const hour = now.getHours();
                
                if (hour < CONFIG.REPORT_START_HOUR) {
                    now.setDate(now.getDate() - 1);
                }
                
                return now.toISOString().split('T')[0];
            },
            
            generateRoomNumbers(building, floor) {
                const range = CONFIG.ROOM_RANGES[building][floor];
                const [start, end] = range.split('-').map(num => parseInt(num));
                const rooms = [];
                
                for (let i = start; i <= end; i++) {
                    rooms.push(building + i.toString().padStart(3, '0'));
                }
                
                return rooms;
            },
            
            getCurrentTimeString() {
                return new Date().toLocaleString('ko-KR', {
                    timeZone: 'Asia/Seoul',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
        };

        // SheetsAPI í´ë˜ìŠ¤
        class SheetsAPI {
            constructor() {
                this.baseUrl = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}`;
                this.cache = new Map();
                this.cacheExpiry = 5 * 60 * 1000;
            }
            
            async readRange(range) {
                const cacheKey = `read_${range}`;
                const cached = this.cache.get(cacheKey);
                
                if (cached && Date.now() - cached.timestamp < this.cacheExpiry) {
                    return cached.data;
                }
                
                try {
                    const url = `${this.baseUrl}/values/${CONFIG.SHEET_NAME}!${range}?key=${CONFIG.API_KEY}`;
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`ì‹œíŠ¸ ì½ê¸° ì‹¤íŒ¨: ${response.status} - ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    const result = data.values || [];
                    
                    this.cache.set(cacheKey, {
                        data: result,
                        timestamp: Date.now()
                    });
                    
                    return result;
                } catch (error) {
                    console.error('ì‹œíŠ¸ ì½ê¸° ì˜¤ë¥˜:', error);
                    throw error;
                }
            }
            
            async findStudentByRoom(roomNumber) {
                try {
                    const data = await this.readRange('A:N');
                    const students = [];
                    
                    for (let i = 1; i < data.length; i++) {
                        const row = data[i];
                        if (row[1] === roomNumber && row[2]) {
                            students.push({
                                rowIndex: i + 1,
                                roomNumber: row[1] || '',
                                name: row[2] || '',
                                status: row[3] || '',
                                memo: row[4] || ''
                            });
                        }
                    }
                    
                    return students;
                } catch (error) {
                    console.error('í•™ìƒ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                    throw error;
                }
            }
            
            async updateStudentStatus(name, status, memo = '') {
                try {
                    const data = await this.readRange('A:N');
                    
                    for (let i = 1; i < data.length; i++) {
                        const row = data[i];
                        if (row[2] === name) {
                            await this.updateCell(i + 1, 4, status);
                            if (memo) {
                                await this.updateCell(i + 1, 5, memo);
                            }
                            return { rowIndex: i + 1, name: row[2] };
                        }
                    }
                    
                    throw new Error(`í•™ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${name}`);
                } catch (error) {
                    console.error('í•™ìƒ ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                    throw error;
                }
            }
            
            async updateCell(row, col, value) {
                const range = `${this.columnToLetter(col)}${row}`;
                return await this.writeRange(range, [[value]]);
            }
            
            async writeRange(range, values) {
                try {
                    const url = `${this.baseUrl}/values/${CONFIG.SHEET_NAME}!${range}?valueInputOption=RAW&key=${CONFIG.API_KEY}`;
                    
                    const response = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            values: values
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`ì‹œíŠ¸ ì“°ê¸° ì‹¤íŒ¨: ${response.status} - ${response.statusText}`);
                    }
                    
                    this.clearCache();
                    return await response.json();
                } catch (error) {
                    console.error('ì‹œíŠ¸ ì“°ê¸° ì˜¤ë¥˜:', error);
                    throw error;
                }
            }
            
            columnToLetter(col) {
                let letter = '';
                while (col > 0) {
                    col--;
                    letter = String.fromCharCode(65 + (col % 26)) + letter;
                    col = Math.floor(col / 26);
                }
                return letter;
            }
            
            clearCache() {
                this.cache.clear();
            }
        }

        // ì „ì—­ ë³€ìˆ˜
        const sheetsAPI = new SheetsAPI();
        let studentRowCount = 0;
        let submittedReports = new Set();

        // í˜ì´ì§€ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initializeForm();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            loadSubmittedReports();
            
            for (let i = 0; i < 5; i++) {
                addStudentRow();
            }
        });

        function initializeForm() {
            const managerSelect = document.getElementById('manager');
            CONFIG.MANAGERS.forEach(manager => {
                const option = document.createElement('option');
                option.value = manager;
                option.textContent = manager;
                managerSelect.appendChild(option);
            });

            const buildingSelect = document.getElementById('building');
            CONFIG.BUILDINGS.forEach(building => {
                const option = document.createElement('option');
                option.value = building;
                option.textContent = building + 'ë™';
                buildingSelect.appendChild(option);
            });

            const floorSelect = document.getElementById('floor');
            CONFIG.FLOORS.forEach(floor => {
                const option = document.createElement('option');
                option.value = floor;
                option.textContent = floor + 'ì¸µ';
                floorSelect.appendChild(option);
            });
        }

        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('ko-KR', {
                timeZone: 'Asia/Seoul',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeString;
        }

        function increaseValue(fieldId) {
            const input = document.getElementById(fieldId);
            input.value = parseInt(input.value) + 1;
        }

        function decreaseValue(fieldId) {
            const input = document.getElementById(fieldId);
            const currentValue = parseInt(input.value);
            if (currentValue > 0) {
                input.value = currentValue - 1;
            }
        }

        function addStudentRow() {
            studentRowCount++;
            const studentRows = document.getElementById('studentRows');
            
            const rowDiv = document.createElement('div');
            rowDiv.className = 'student-row';
            rowDiv.id = `studentRow${studentRowCount}`;
            
            rowDiv.innerHTML = `
                <button type="button" class="delete-btn" onclick="removeStudentRow(${studentRowCount})">
                    <i class="fas fa-times"></i>
                </button>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>ë™</label>
                        <select name="studentBuilding${studentRowCount}" onchange="updateRoomOptions(${studentRowCount})">
                            <option value="">ë™ ì„ íƒ</option>
                            ${CONFIG.BUILDINGS.map(b => `<option value="${b}">${b}ë™</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ì¸µ</label>
                        <select name="studentFloor${studentRowCount}" onchange="updateRoomOptions(${studentRowCount})">
                            <option value="">ì¸µ ì„ íƒ</option>
                            ${CONFIG.FLOORS.map(f => `<option value="${f}">${f}ì¸µ</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ê¸°ìˆ™ì‚¬</label>
                        <select name="studentRoom${studentRowCount}" onchange="updateStudentName(${studentRowCount})">
                            <option value="">ê¸°ìˆ™ì‚¬ ì„ íƒ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ì´ë¦„</label>
                        <input type="text" name="studentName${studentRowCount}" readonly placeholder="ìë™ ì…ë ¥">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>ìƒíƒœ</label>
                        <select name="studentStatus${studentRowCount}">
                            <option value="">ìƒíƒœ ì„ íƒ</option>
                            ${CONFIG.STATUS_TYPES.map(s => `<option value="${s}">${s}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ë©”ëª¨</label>
                        <input type="text" name="studentMemo${studentRowCount}" placeholder="ë©”ëª¨ ì…ë ¥">
                    </div>
                </div>
            `;
            
            studentRows.appendChild(rowDiv);
        }

        function removeStudentRow(rowId) {
            const row = document.getElementById(`studentRow${rowId}`);
            if (row) {
                row.remove();
            }
        }

        async function updateRoomOptions(rowId) {
            const buildingSelect = document.querySelector(`select[name="studentBuilding${rowId}"]`);
            const floorSelect = document.querySelector(`select[name="studentFloor${rowId}"]`);
            const roomSelect = document.querySelector(`select[name="studentRoom${rowId}"]`);
            
            const building = buildingSelect.value;
            const floor = floorSelect.value;
            
            roomSelect.innerHTML = '<option value="">ê¸°ìˆ™ì‚¬ ì„ íƒ</option>';
            
            if (building && floor) {
                try {
                    const rooms = Utils.generateRoomNumbers(building, floor);
                    rooms.forEach(room => {
                        const option = document.createElement('option');
                        option.value = room;
                        option.textContent = room;
                        roomSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('í˜¸ì‹¤ ì˜µì…˜ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                }
            }
        }

        async function updateStudentName(rowId) {
            const roomSelect = document.querySelector(`select[name="studentRoom${rowId}"]`);
            const nameInput = document.querySelector(`input[name="studentName${rowId}"]`);
            
            const roomNumber = roomSelect.value;
            
            if (roomNumber) {
                try {
                    const students = await sheetsAPI.findStudentByRoom(roomNumber);
                    if (students.length > 0) {
                        if (students.length === 1) {
                            nameInput.value = students[0].name;
                        } else {
                            nameInput.value = students.map(s => s.name).join(', ');
                        }
                    } else {
                        nameInput.value = '';
                        showAlert('í•´ë‹¹ í˜¸ì‹¤ì— ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                    }
                } catch (error) {
                    console.error('í•™ìƒ ì´ë¦„ ì¡°íšŒ ì˜¤ë¥˜:', error);
                    nameInput.value = '';
                    showAlert('í•™ìƒ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            } else {
                nameInput.value = '';
            }
        }

        function loadSubmittedReports() {
            const stored = localStorage.getItem('submittedReports');
            if (stored) {
                submittedReports = new Set(JSON.parse(stored));
            }
        }

        function saveSubmittedReport(reportKey) {
            submittedReports.add(reportKey);
            localStorage.setItem('submittedReports', JSON.stringify([...submittedReports]));
        }

        // í¼ ì œì¶œ ì²˜ë¦¬
        document.getElementById('reportForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // API í‚¤ í™•ì¸
            if (CONFIG.API_KEY === 'YOUR_GOOGLE_SHEETS_API_KEY') {
                showAlert('Google Sheets API í‚¤ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”. ì†ŒìŠ¤ì½”ë“œì—ì„œ CONFIG.API_KEYë¥¼ ì‹¤ì œ API í‚¤ë¡œ ë³€ê²½í•˜ì„¸ìš”.', 'error');
                return;
            }
            
            // ë³´ê³  ì‹œê°„ í™•ì¸
            if (!Utils.isValidReportTime()) {
                showAlert('ë³´ê³  ê°€ëŠ¥ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤. (22:00 ~ 21:59)', 'error');
                return;
            }
            
            const formData = new FormData(this);
            const building = formData.get('building');
            const floor = formData.get('floor');
            const manager = formData.get('manager');
            
            if (!building || !floor || !manager) {
                showAlert('ë‹´ë‹¹ì, ë™, ì¸µì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            // ì¤‘ë³µ ë³´ê³  í™•ì¸
            const reportKey = `${Utils.getReportPeriodId()}_${building}_${floor}`;
            if (submittedReports.has(reportKey)) {
                if (!confirm('ì´ë¯¸ í•´ë‹¹ ë™/ì¸µì— ëŒ€í•´ ë³´ê³ í•˜ì…¨ìŠµë‹ˆë‹¤. ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }
            }
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì œì¶œ ì¤‘...';
            
            try {
                await submitReport(formData, reportKey);
                showAlert('ì¸ì›ë³´ê³ ê°€ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                saveSubmittedReport(reportKey);
                
                // í¼ ì´ˆê¸°í™”
                this.reset();
                studentRowCount = 0;
                document.getElementById('studentRows').innerHTML = '';
                for (let i = 0; i < 5; i++) {
                    addStudentRow();
                }
                
            } catch (error) {
                console.error('ì œì¶œ ì˜¤ë¥˜:', error);
                showAlert('ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> ì¸ì›ë³´ê³  ì œì¶œ';
            }
        });

        // ë³´ê³ ì„œ ì œì¶œ ì²˜ë¦¬
        async function submitReport(formData, reportKey) {
            const reportData = {
                timestamp: Utils.getCurrentTimeString(),
                manager: formData.get('manager'),
                building: formData.get('building'),
                floor: formData.get('floor'),
                overnight: parseInt(formData.get('overnight')) || 0,
                checkout: parseInt(formData.get('checkout')) || 0,
                moveIn: parseInt(formData.get('moveIn')) || 0,
                moveOut: parseInt(formData.get('moveOut')) || 0,
                currentCount: parseInt(formData.get('currentCount')) || 0,
                outing: parseInt(formData.get('outing')) || 0,
                etc: parseInt(formData.get('etc')) || 0,
                memo: formData.get('memo') || '',
                students: [],
                isModification: submittedReports.has(reportKey)
            };
            
            // ê°œë³„ í•™ìƒ ì •ë³´ ìˆ˜ì§‘
            for (let i = 1; i <= studentRowCount; i++) {
                const rowElement = document.getElementById(`studentRow${i}`);
                if (!rowElement) continue;
                
                const building = formData.get(`studentBuilding${i}`);
                const floor = formData.get(`studentFloor${i}`);
                const room = formData.get(`studentRoom${i}`);
                const name = formData.get(`studentName${i}`);
                const status = formData.get(`studentStatus${i}`);
                const memo = formData.get(`studentMemo${i}`);
                
                if (building && floor && room && name && status) {
                    reportData.students.push({
                        building,
                        floor,
                        room,
                        name,
                        status,
                        memo: memo || ''
                    });
                }
            }
            
            // Google Sheets ì—…ë°ì´íŠ¸
            await updateSheetsWithReport(reportData);
            
            // Jandi ì•Œë¦¼ ì „ì†¡
            await sendJandiNotification(reportData);
        }

        // ë³´ê³  ë°ì´í„° ì €ì¥ (ì§‘ê³„ìš©)
        function saveReportData(reportData) {
            const reportDate = Utils.getReportPeriodId();
            const storedReports = JSON.parse(localStorage.getItem('dailyReports') || '{}');
            
            if (!storedReports[reportDate]) {
                storedReports[reportDate] = {};
            }
            
            const reportKey = `${reportData.building}_${reportData.floor}`;
            storedReports[reportDate][reportKey] = reportData;
            
            localStorage.setItem('dailyReports', JSON.stringify(storedReports));
        }

        // Google Sheets ì—…ë°ì´íŠ¸
        async function updateSheetsWithReport(reportData) {
            // ê°œë³„ í•™ìƒ ìƒíƒœ ì—…ë°ì´íŠ¸
            for (const student of reportData.students) {
                try {
                    await sheetsAPI.updateStudentStatus(student.name, student.status, student.memo);
                } catch (error) {
                    console.warn(`í•™ìƒ ${student.name} ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:`, error);
                }
            }
            
            // ë³´ê³  ë°ì´í„° ì €ì¥ (ì§‘ê³„ìš©)
            saveReportData(reportData);
        }

        // Jandi ì•Œë¦¼ ì „ì†¡
        async function sendJandiNotification(reportData) {
            const message = createJandiMessage(reportData);
            
            try {
                const response = await fetch(CONFIG.JANDI_WEBHOOK, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        body: message,
                        connectColor: reportData.isModification ? '#FFA500' : '#4facfe'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Jandi ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('Jandi ì•Œë¦¼ ì˜¤ë¥˜:', error);
                throw error;
            }
        }

        // Jandi ë©”ì‹œì§€ ìƒì„±
        function createJandiMessage(reportData) {
            const modificationText = reportData.isModification ? '[ìˆ˜ì •] ' : '';
            let message = `${modificationText}ğŸ  ê¸°ìˆ™ì‚¬ ì¸ì›ë³´ê³ \n\n`;
            message += `ğŸ“… ë³´ê³ ì‹œê°„: ${reportData.timestamp}\n`;
            message += `ğŸ‘¤ ë‹´ë‹¹ì: ${reportData.manager}\n`;
            message += `ğŸ¢ ìœ„ì¹˜: ${reportData.building}ë™ ${reportData.floor}ì¸µ\n\n`;
            
            message += `ğŸ“Š ì¸ì› í˜„í™©:\n`;
            if (reportData.currentCount > 0) message += `ğŸ‘¥ í˜„ì¬ì›: ${reportData.currentCount}ëª…\n`;
            if (reportData.overnight > 0) message += `ğŸŒ™ ì™¸ë°•: ${reportData.overnight}ëª…\n`;
            if (reportData.outing > 0) message += `ğŸš¶ ì™¸ì¶œ: ${reportData.outing}ëª…\n`;
            if (reportData.checkout > 0) message += `ğŸšª í‡´ì†Œ: ${reportData.checkout}ëª…\n`;
            if (reportData.moveIn > 0) message += `â• ì´ë™(ì…): ${reportData.moveIn}ëª…\n`;
            if (reportData.moveOut > 0) message += `â– ì´ë™(ì¶œ): ${reportData.moveOut}ëª…\n`;
            if (reportData.etc > 0) message += `â“ ê¸°íƒ€: ${reportData.etc}ëª…\n`;
            
            if (reportData.students.length > 0) {
                message += `\nğŸ‘¥ ê°œë³„ í•™ìƒ í˜„í™©:\n`;
                reportData.students.forEach(student => {
                    message += `â€¢ ${student.name} (${student.room}) - ${student.status}`;
                    if (student.memo) message += ` (${student.memo})`;
                    message += '\n';
                });
            }
            
            if (reportData.memo) {
                message += `\nğŸ“ ê¸°íƒ€ì‚¬í•­: ${reportData.memo}`;
            }
            
            return message;
        }

        // ì•Œë¦¼ í‘œì‹œ
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type}`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                ${message}
            `;
            
            alertContainer.appendChild(alertDiv);
            
            // 5ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
            
            // ìŠ¤í¬ë¡¤ì„ ì•Œë¦¼ìœ¼ë¡œ ì´ë™
            alertDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    </script>
</body>
</html>
