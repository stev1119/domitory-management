<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>기숙사 인원보고 시스템</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            --secondary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --accent-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --glass-bg: rgba(255, 255, 255, 0.12);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.85);
            --text-accent: rgba(255, 255, 255, 0.95);
            --shadow-light: 0 8px 32px rgba(0, 0, 0, 0.2);
            --shadow-heavy: 0 20px 60px rgba(0, 0, 0, 0.3);
            --logo-shadow: 0 4px 20px rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            padding: 15px;
            color: var(--text-primary);
            background-attachment: fixed;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(120, 219, 255, 0.15) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* 반응형 레이아웃 */
        @media (min-width: 1024px) {
            .container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 30px;
                align-items: start;
            }

            .left-column {
                grid-column: 1;
            }

            .right-column {
                grid-column: 2;
            }

            .main-header {
                grid-column: 1 / -1;
                margin-bottom: 30px;
            }

            .form-container {
                height: fit-content;
                position: sticky;
                top: 20px;
            }
        }

        @media (max-width: 1023px) {
            .container {
                max-width: 500px;
            }
        }

        .main-header {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            border: 2px solid var(--glass-border);
            border-radius: 28px;
            padding: 35px 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-heavy);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .main-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: none;
            opacity: 0;
            z-index: 0;
        }

        .form-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: none;
            opacity: 0;
            z-index: 0;
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .header-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
        }

        .logo-container {
            width: 70px;
            height: 70px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 12px;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--logo-shadow);
            transition: all 0.3s ease;
        }

        .logo-container:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 30px rgba(255, 255, 255, 0.2);
        }

        .logo-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: brightness(1.2) contrast(1.1);
        }

        .main-header h1 {
            font-size: 2.2rem;
            background: linear-gradient(135deg, #ffffff 0%, #e3f2fd 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .main-header .subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 20px;
            font-weight: 500;
        }

        .time-display {
            background: var(--accent-gradient);
            color: white;
            padding: 12px 20px;
            border-radius: 20px;
            display: inline-block;
            font-weight: 700;
            font-size: 1rem;
            box-shadow: 0 4px 20px rgba(79, 172, 254, 0.4);
            transition: all 0.3s ease;
        }

        .time-display:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(79, 172, 254, 0.6);
        }

        .form-container {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            border: 2px solid var(--glass-border);
            border-radius: 24px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-light);
            position: relative;
            overflow: hidden;
        }

        .form-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: none;
            opacity: 0.03;
            z-index: 0;
        }

        .form-content {
            position: relative;
            z-index: 1;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 25px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .section-header i {
            font-size: 1.4rem;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .section-header h2 {
            font-size: 1.3rem;
            color: var(--text-accent);
            font-weight: 700;
            letter-spacing: -0.3px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        }

        .form-group label {
            display: block;
            font-weight: 700;
            color: var(--text-accent);
            margin-bottom: 8px;
            font-size: 0.9rem;
            letter-spacing: 0.3px;
        }

        .form-group select,
        .form-group input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 14px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
            backdrop-filter: blur(10px);
            font-weight: 500;
        }

        .form-group select option {
            background: #2c3e50;
            color: white;
            padding: 8px;
        }

        .form-group select:focus,
        .form-group input[type="text"]:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2);
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .number-input-group {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 18px;
            padding: 18px 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            transition: all 0.4s ease;
            backdrop-filter: blur(10px);
        }

        .number-input-group:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-3px);
            border-color: rgba(79, 172, 254, 0.3);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.15);
        }

        .number-input-group label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-accent);
            margin-bottom: 10px;
            display: block;
            letter-spacing: 0.5px;
        }

        .number-input {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .number-input button {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--accent-gradient);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 3px 12px rgba(79, 172, 254, 0.4);
        }

        .number-input button:hover {
            transform: scale(1.15);
            box-shadow: 0 5px 20px rgba(79, 172, 254, 0.6);
        }

        .number-input input {
            width: 60px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 700;
            padding: 8px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .number-input input:focus {
            border-color: #4facfe;
            background: rgba(255, 255, 255, 0.15);
            outline: none;
        }

        .individual-section {
            border-left: 4px solid #ff6b6b;
        }

        .student-row {
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 18px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
            transition: all 0.4s ease;
            backdrop-filter: blur(10px);
        }

        .student-row:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-3px);
            box-shadow: var(--shadow-light);
        }

        .student-row.has-data {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.15);
            box-shadow: 0 4px 20px rgba(40, 167, 69, 0.2);
        }

        .delete-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--warning-gradient);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 3px 12px rgba(240, 147, 251, 0.4);
        }

        .delete-btn:hover {
            transform: rotate(90deg) scale(1.15);
            box-shadow: 0 5px 20px rgba(240, 147, 251, 0.6);
        }

        .student-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }

        @media (max-width: 600px) {
            .student-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }

        .add-btn {
            background: var(--success-gradient);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 18px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            margin: 20px 0;
            transition: all 0.3s ease;
            width: 100%;
            box-shadow: 0 4px 20px rgba(17, 153, 142, 0.4);
            letter-spacing: 0.3px;
        }

        .add-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(17, 153, 142, 0.6);
        }

        .submit-btn {
            background: var(--accent-gradient);
            color: white;
            border: none;
            padding: 18px 30px;
            border-radius: 20px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            margin-top: 25px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-light);
            letter-spacing: 0.3px;
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-heavy);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .reset-btn {
            background: var(--warning-gradient);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 16px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(240, 147, 251, 0.4);
        }

        .reset-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(240, 147, 251, 0.6);
        }

        .modification-checkbox {
            background: rgba(255, 193, 7, 0.15);
            border: 2px solid rgba(255, 193, 7, 0.3);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 25px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .modification-checkbox label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-accent);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modification-checkbox label:hover {
            transform: scale(1.02);
        }

        .modification-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #ffc107;
            transform: scale(1.2);
        }

        .alert {
            padding: 16px 20px;
            border-radius: 16px;
            margin: 20px 0;
            border: none;
            font-weight: 600;
            font-size: 1rem;
            backdrop-filter: blur(15px);
            box-shadow: var(--shadow-light);
            transition: all 0.3s ease;
        }

        .alert:hover {
            transform: translateY(-2px);
        }

        .alert.success {
            background: rgba(40, 167, 69, 0.15);
            color: #d4edda;
            border: 2px solid rgba(40, 167, 69, 0.3);
        }

        .alert.error {
            background: rgba(220, 53, 69, 0.15);
            color: #f8d7da;
            border: 2px solid rgba(220, 53, 69, 0.3);
        }

        .alert.warning {
            background: rgba(255, 193, 7, 0.15);
            color: #fff3cd;
            border: 2px solid rgba(255, 193, 7, 0.3);
        }

        .alert.info {
            background: rgba(79, 172, 254, 0.15);
            color: #d1ecf1;
            border: 2px solid rgba(79, 172, 254, 0.3);
        }

        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
        }

        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            margin: 10% auto;
            padding: 30px;
            border-radius: 24px;
            width: 90%;
            max-width: 450px;
            border: 2px solid var(--glass-border);
            box-shadow: var(--shadow-heavy);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 15px;
        }

        .modal-header h3 {
            color: var(--text-accent);
            font-size: 1.4rem;
            font-weight: 700;
        }

        .close {
            color: var(--text-secondary);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close:hover {
            color: #ff4757;
            background: rgba(255, 71, 87, 0.15);
            transform: rotate(90deg);
        }

        .password-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 14px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            margin-bottom: 20px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .password-input:focus {
            outline: none;
            border-color: #4facfe;
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .modal-btn {
            background: var(--accent-gradient);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 14px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(79, 172, 254, 0.4);
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(79, 172, 254, 0.6);
        }

        /* 스크롤바 스타일링 */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* 모바일 최적화 */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .main-header {
                padding: 25px 20px;
            }

            .main-header h1 {
                font-size: 1.8rem;
            }

            .logo-container {
                width: 60px;
                height: 60px;
            }

            .form-container {
                padding: 20px;
            }

            .number-input button {
                width: 28px;
                height: 28px;
                font-size: 0.9rem;
            }

            .number-input input {
                width: 50px;
                font-size: 1rem;
            }

            .student-row {
                padding: 16px;
            }

            .modal-content {
                width: 95%;
                padding: 25px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 메인 헤더 -->
        <div class="main-header">
            <div class="header-content">
                <div class="header-logo">
                    <div class="logo-container">
                        <svg width="40" height="40" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M50 10 L85 75 L15 75 Z" fill="white" stroke="white" stroke-width="2"/>
                            <circle cx="50" cy="45" r="8" fill="#1e3c72"/>
                            <path d="M40 55 L50 75 L60 55 Z" fill="#1e3c72"/>
                        </svg>
                    </div>
                    <h1>기숙사 인원보고</h1>
                </div>
                <p class="subtitle">매일 22:00 ~ 다음날 21:59까지 보고 가능</p>
                <div class="time-display">
                    <i class="fas fa-clock"></i> <span id="currentTime"></span>
                </div>
            </div>
        </div>

        <!-- 리셋 버튼 -->
        <button class="reset-btn" onclick="showResetModal()">
            <i class="fas fa-undo"></i> 시트 데이터 리셋 (관리자)
        </button>

        <div class="left-column">
            <div id="alertContainer"></div>

            <form id="reportForm">
                <!-- 기본 보고 정보 -->
                <div class="form-container">
                    <div class="form-content">
                        <div class="section-header">
                            <i class="fas fa-user-tie"></i>
                            <h2>기본 정보</h2>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="manager">담당자</label>
                                <select id="manager" name="manager" required>
                                    <option value="">선택</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="building">동</label>
                                <select id="building" name="building" required>
                                    <option value="">선택</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="floor">층</label>
                                <select id="floor" name="floor" required>
                                    <option value="">선택</option>
                                </select>
                            </div>
                        </div>

                        <!-- 수정 보고 체크박스 -->
                        <div id="modificationCheckbox" class="modification-checkbox" style="display: none;">
                            <label>
                                <input type="checkbox" id="isModification" name="isModification">
                                <i class="fas fa-edit"></i>
                                기존 보고 수정
                            </label>
                        </div>

                        <div class="stats-grid">
                            <div class="number-input-group">
                                <label>현재원</label>
                                <div class="number-input">
                                    <button type="button" onclick="decreaseValue('currentCount')">-</button>
                                    <input type="number" id="currentCount" name="currentCount" value="0" min="0">
                                    <button type="button" onclick="increaseValue('currentCount')">+</button>
                                </div>
                            </div>
                            <div class="number-input-group">
                                <label>외박</label>
                                <div class="number-input">
                                    <button type="button" onclick="decreaseValue('overnight')">-</button>
                                    <input type="number" id="overnight" name="overnight" value="0" min="0">
                                    <button type="button" onclick="increaseValue('overnight')">+</button>
                                </div>
                            </div>
                            <div class="number-input-group">
                                <label>외출</label>
                                <div class="number-input">
                                    <button type="button" onclick="decreaseValue('outing')">-</button>
                                    <input type="number" id="outing" name="outing" value="0" min="0">
                                    <button type="button" onclick="increaseValue('outing')">+</button>
                                </div>
                            </div>
                            <div class="number-input-group">
                                <label>퇴소</label>
                                <div class="number-input">
                                    <button type="button" onclick="decreaseValue('checkout')">-</button>
                                    <input type="number" id="checkout" name="checkout" value="0" min="0">
                                    <button type="button" onclick="increaseValue('checkout')">+</button>
                                </div>
                            </div>
                            <div class="number-input-group">
                                <label>신규</label>
                                <div class="number-input">
                                    <button type="button" onclick="decreaseValue('newStudent')">-</button>
                                    <input type="number" id="newStudent" name="newStudent" value="0" min="0">
                                    <button type="button" onclick="increaseValue('newStudent')">+</button>
                                </div>
                            </div>
                            <div class="number-input-group">
                                <label>이동OUT</label>
                                <div class="number-input">
                                    <button type="button" onclick="decreaseValue('moveOut')">-</button>
                                    <input type="number" id="moveOut" name="moveOut" value="0" min="0">
                                    <button type="button" onclick="increaseValue('moveOut')">+</button>
                                </div>
                            </div>
                            <div class="number-input-group">
                                <label>이동IN</label>
                                <div class="number-input">
                                    <button type="button" onclick="decreaseValue('moveIn')">-</button>
                                    <input type="number" id="moveIn" name="moveIn" value="0" min="0">
                                    <button type="button" onclick="increaseValue('moveIn')">+</button>
                                </div>
                            </div>
                            <div class="number-input-group">
                                <label>기타</label>
                                <div class="number-input">
                                    <button type="button" onclick="decreaseValue('etc')">-</button>
                                    <input type="number" id="etc" name="etc" value="0" min="0">
                                    <button type="button" onclick="increaseValue('etc')">+</button>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="memo">기타 사항</label>
                            <input type="text" id="memo" name="memo" placeholder="기타 내용을 입력하세요">
                        </div>
                    </div>
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">
                    <i class="fas fa-paper-plane"></i> 인원보고 제출
                </button>
            </form>
        </div>

        <div class="right-column">
            <!-- 개별 학생 정보 입력 -->
            <div class="form-container individual-section">
                <div class="form-content">
                    <div class="section-header">
                        <i class="fas fa-users"></i>
                        <h2>개별 학생 정보</h2>
                    </div>
                    <div id="studentRows">
                        <!-- 학생 행들이 동적으로 추가될 예정 -->
                    </div>
                    <button type="button" class="add-btn" onclick="addStudentRow()">
                        <i class="fas fa-plus"></i> 학생 추가
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 리셋 모달 -->
    <div id="resetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>데이터 리셋</h3>
                <span class="close" onclick="closeResetModal()">&times;</span>
            </div>
            <div>
                <label style="color: var(--text-accent); font-size: 1rem; margin-bottom: 10px; display: block; font-weight: 700;">관리자 비밀번호</label>
                <input type="password" id="resetPassword" class="password-input" placeholder="비밀번호를 입력하세요">
                <button type="button" class="modal-btn" onclick="executeReset()">
                    <i class="fas fa-trash"></i> 시트 D,E열 리셋 실행
                </button>
            </div>
        </div>
    </div>

    <script>
        // CONFIG 설정 (정확한 호실 범위로 수정)
        const CONFIG = {
            SHEET_ID: '1cASz2h4Dd13H6vhdKAPHOFdf5BMsFjaFledqVbzpP8I',
            SHEET_NAME: 'yulee',
            API_KEY: 'AIzaSyA1uY-EDvpxvxqyXTDwjNpS2ugYXQ3igtk',
            
            // Google Apps Script 웹앱 URL (실제 배포된 URL)
            WEBAPP_URL: 'https://script.google.com/macros/s/AKfycbyqOma-J5J44BewIq9GeEvYjq0390UA0jm7prZbjjGQ5xjZi-mxojOlxv_I6c7Not67/exec',
            
            JANDI_WEBHOOK: 'https://wh.jandi.com/connect-api/webhook/29522216/3d9603c3b428b386c0d640758e236cb4',
            
            MANAGERS: [
                '이영운', '김혜정', '이시우', '고승완', '남인달',
                '조영권', '황민철', '강지훈', '김건희', '송인수',
                '김영현', '김미경', '유나경', '진정현', '원현주',
                '김지현', '김정아', '신규1', '신규2', '신규3',
                '신규4', '신규5', '신규6', '신규7'
            ],
            
            BUILDINGS: ['A', 'B', 'C', 'D', 'E', 'F'],
            FLOORS: [1, 2, 3, 4],
            
            GENDER_BY_BUILDING: {
                'A': '남', 'B': '남', 'C': '남', 'F': '남',
                'D': '여', 'E': '여'
            },
            
            // 정확한 호실 범위 (실제 시트 데이터 기준)
            ROOM_RANGES: {
                'A': { 
                    '1': [101, 160], '2': [201, 262], '3': [301, 362], '4': [401, 432] 
                },
                'B': { 
                    '1': [101, 140], '2': [201, 241], '3': [301, 341], '4': [401, 421] 
                },
                'C': { 
                    '1': [101, 161], '2': [201, 262], '3': [301, 362], '4': [401, 432]
                },
                'D': { 
                    '1': [101, 144], '2': [201, 245], '3': [301, 345], '4': [401, 423] 
                },
                'E': { 
                    '1': [101, 176], '2': [201, 278], '3': [301, 378], '4': [401, 440] 
                },
                'F': { 
                    '1': [101, 132], '2': [201, 233], '3': [301, 333], '4': [401, 417] 
                }
            },
            
            // 3인실 정보 (모든 동의 4층은 3인실)
            TRIPLE_ROOMS: {
                'A4': true, 'B4': true, 'C4': true, 'D4': true, 'E4': true, 'F4': true
            },
            
            STATUS_TYPES: [
                '외박', '외출', '퇴소', '이동+', '이동-', '정상', '신규', '기타'
            ],
            
            REPORT_START_HOUR: 22,
            REPORT_END_HOUR: 21,
            REPORT_END_MINUTE: 59,
            
            RESET_PASSWORD: '3825'
        };

        // Utils 클래스
        const Utils = {
            isValidReportTime() {
                const now = new Date();
                const hour = now.getHours();
                const minute = now.getMinutes();
                
                return hour >= CONFIG.REPORT_START_HOUR || 
                       (hour < CONFIG.REPORT_END_HOUR) || 
                       (hour === CONFIG.REPORT_END_HOUR && minute <= CONFIG.REPORT_END_MINUTE);
            },
            
            getReportPeriodId() {
                const now = new Date();
                const hour = now.getHours();
                
                if (hour < CONFIG.REPORT_START_HOUR) {
                    now.setDate(now.getDate() - 1);
                }
                
                return now.toISOString().split('T')[0];
            },
            
            getCurrentTimeString() {
                return new Date().toLocaleString('ko-KR', {
                    timeZone: 'Asia/Seoul',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        };

        // SheetsAPI 클래스 (구글 시트 연동 개선)
        class SheetsAPI {
            constructor() {
                this.baseUrl = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}`;
                this.cache = new Map();
                this.cacheExpiry = 5 * 60 * 1000;
            }
            
            async readRange(range) {
                const cacheKey = `read_${range}`;
                const cached = this.cache.get(cacheKey);
                
                if (cached && Date.now() - cached.timestamp < this.cacheExpiry) {
                    return cached.data;
                }
                
                try {
                    const url = `${this.baseUrl}/values/${CONFIG.SHEET_NAME}!${range}?key=${CONFIG.API_KEY}`;
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`시트 읽기 실패: ${response.status} - ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    const result = data.values || [];
                    
                    this.cache.set(cacheKey, {
                        data: result,
                        timestamp: Date.now()
                    });
                    
                    return result;
                } catch (error) {
                    console.error('시트 읽기 오류:', error);
                    throw error;
                }
            }
            
            async findStudentByRoom(roomNumber) {
                try {
                    const building = roomNumber.charAt(0);
                    const floor = roomNumber.charAt(1);
                    const room = parseInt(roomNumber.substring(1));
                    
                    // 전체 데이터에서 B열(호실번호) 기준으로 검색
                    const data = await this.readRange('A1:N2000');
                    const students = [];
                    
                    for (let i = 1; i < data.length; i++) {
                        const row = data[i];
                        if (row[1] === roomNumber && row[2] && row[2].trim() !== '미배정') {
                            students.push({
                                rowIndex: i + 1,
                                roomNumber: row[1] || '',
                                name: row[2] || '',
                                status: row[3] || '',
                                memo: row[4] || ''
                            });
                        }
                    }
                    return students;
                } catch (error) {
                    console.error('학생 검색 오류:', error);
                    throw error;
                }
            }
            
            // 학생 상태 업데이트 함수 (웹앱 사용)
            async updateStudentStatus(name, status, memo = '') {
                try {
                    console.log(`학생 상태 업데이트 시작: ${name} -> ${status}`);
                    
                    // 웹앱 URL이 설정되어 있으면 웹앱 사용
                    if (CONFIG.WEBAPP_URL && CONFIG.WEBAPP_URL.includes('script.google.com')) {
                        return await this.updateViaWebApp(name, status, memo);
                    }
                    
                    // 아니면 직접 API 호출 (읽기 전용이지만 시도)
                    return await this.updateViaDirectAPI(name, status, memo);
                    
                } catch (error) {
                    console.error('학생 상태 업데이트 오류:', error);
                    // 에러가 나도 로컬 스토리지에 저장
                    this.saveToLocalStorage(name, status, memo);
                    throw error;
                }
            }
            
            // 웹앱을 통한 업데이트
            async updateViaWebApp(name, status, memo) {
                try {
                    const response = await fetch(CONFIG.WEBAPP_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'updateStudent',
                            name: name,
                            status: status === '정상' ? '' : status,
                            memo: memo || ''
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`웹앱 호출 실패: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    this.clearCache();
                    return result;
                } catch (error) {
                    console.error('웹앱 업데이트 오류:', error);
                    throw error;
                }
            }
            
            // 직접 API를 통한 업데이트 (폴백)
            async updateViaDirectAPI(name, status, memo) {
                // 먼저 일반실에서 찾기
                const data = await this.readRange('A:E');
                
                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    if (row[2] === name && row[2].trim() !== '미배정') {
                        console.log(`학생 발견: 행 ${i + 1}`);
                        
                        // 간단한 방식으로 업데이트 시도
                        await this.writeRange(`D${i + 1}`, [[status === '정상' ? '' : status]]);
                        if (memo !== undefined) {
                            await this.writeRange(`E${i + 1}`, [[memo]]);
                        }
                        return { rowIndex: i + 1, name: row[2] };
                    }
                }
                
                throw new Error(`학생을 찾을 수 없습니다: ${name}`);
            }
            
            // 로컬 스토리지에 백업 저장
            saveToLocalStorage(name, status, memo) {
                const updates = JSON.parse(localStorage.getItem('pendingUpdates') || '[]');
                updates.push({
                    name,
                    status,
                    memo,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('pendingUpdates', JSON.stringify(updates));
                console.log('로컬 스토리지에 백업 저장됨:', { name, status, memo });
            }
            
            async resetAllStatuses() {
                try {
                    console.log('모든 상태 리셋 시작...');
                    
                    // 웹앱 URL이 설정되어 있으면 웹앱 사용
                    if (CONFIG.WEBAPP_URL && CONFIG.WEBAPP_URL.includes('script.google.com') && !CONFIG.WEBAPP_URL.includes('YOUR_WEBAPP_ID')) {
                        const response = await fetch(CONFIG.WEBAPP_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                action: 'resetAll'
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`웹앱 호출 실패: ${response.status}`);
                        }
                        
                        const result = await response.json();
                        if (result.error) {
                            throw new Error(result.error);
                        }
                        
                        this.clearCache();
                        console.log('웹앱을 통한 리셋 완료');
                        return;
                    }
                    
                    // 웹앱이 설정되지 않은 경우
                    throw new Error('Google Apps Script 웹앱이 설정되지 않았습니다.');
                    
                } catch (error) {
                    console.error('상태 리셋 오류:', error);
                    throw error;
                }
            }
            
            async updateCell(row, col, value) {
                const range = `${this.columnToLetter(col)}${row}`;
                return await this.writeRange(range, [[value]]);
            }
            
            async writeRange(range, values) {
                try {
                    const url = `${this.baseUrl}/values/${CONFIG.SHEET_NAME}!${range}?valueInputOption=RAW&key=${CONFIG.API_KEY}`;
                    
                    const response = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            values: values
                        })
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`시트 쓰기 실패: ${response.status} - ${errorText}`);
                    }
                    
                    this.clearCache();
                    return await response.json();
                } catch (error) {
                    console.error('시트 쓰기 오류:', error);
                    throw error;
                }
            }
            
            columnToLetter(col) {
                let letter = '';
                while (col > 0) {
                    col--;
                    letter = String.fromCharCode(65 + (col % 26)) + letter;
                    col = Math.floor(col / 26);
                }
                return letter;
            }
            
            clearCache() {
                this.cache.clear();
            }
        }

        // 전역 변수
        const sheetsAPI = new SheetsAPI();
        let studentRowCount = 0;
        let submittedReports = new Set();

        // 페이지 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initializeForm();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            loadSubmittedReports();
            
            // 동/층 변경 시 기존 보고 확인
            document.getElementById('building').addEventListener('change', checkExistingReport);
            document.getElementById('floor').addEventListener('change', checkExistingReport);
            
            // 초기 학생 행 2개 추가
            for (let i = 0; i < 2; i++) {
                addStudentRow();
            }
        });

        function initializeForm() {
            const managerSelect = document.getElementById('manager');
            CONFIG.MANAGERS.forEach(manager => {
                const option = document.createElement('option');
                option.value = manager;
                option.textContent = manager;
                managerSelect.appendChild(option);
            });

            const buildingSelect = document.getElementById('building');
            CONFIG.BUILDINGS.forEach(building => {
                const option = document.createElement('option');
                option.value = building;
                option.textContent = building + '동';
                buildingSelect.appendChild(option);
            });

            const floorSelect = document.getElementById('floor');
            CONFIG.FLOORS.forEach(floor => {
                const option = document.createElement('option');
                option.value = floor;
                option.textContent = floor + '층';
                floorSelect.appendChild(option);
            });
        }

        function updateCurrentTime() {
            document.getElementById('currentTime').textContent = Utils.getCurrentTimeString();
        }

        function increaseValue(fieldId) {
            const input = document.getElementById(fieldId);
            input.value = parseInt(input.value) + 1;
            input.style.transform = 'scale(1.1)';
            setTimeout(() => input.style.transform = 'scale(1)', 200);
        }

        function decreaseValue(fieldId) {
            const input = document.getElementById(fieldId);
            const currentValue = parseInt(input.value);
            if (currentValue > 0) {
                input.value = currentValue - 1;
                input.style.transform = 'scale(1.1)';
                setTimeout(() => input.style.transform = 'scale(1)', 200);
            }
        }

        function addStudentRow() {
            studentRowCount++;
            const studentRows = document.getElementById('studentRows');
            
            const rowDiv = document.createElement('div');
            rowDiv.className = 'student-row';
            rowDiv.id = `studentRow${studentRowCount}`;
            
            rowDiv.innerHTML = `
                <button type="button" class="delete-btn" onclick="removeStudentRow(${studentRowCount})" title="삭제">
                    <i class="fas fa-times"></i>
                </button>
                
                <div class="student-grid">
                    <div class="form-group">
                        <label>동</label>
                        <select name="studentBuilding${studentRowCount}" onchange="updateRoomOptions(${studentRowCount})">
                            <option value="">선택</option>
                            ${CONFIG.BUILDINGS.map(b => `<option value="${b}">${b}동</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>층</label>
                        <select name="studentFloor${studentRowCount}" onchange="updateRoomOptions(${studentRowCount})">
                            <option value="">선택</option>
                            ${CONFIG.FLOORS.map(f => `<option value="${f}">${f}층</option>`).join('')}
                        </select>
                    </div>
                </div>
                
                <div class="student-grid">
                    <div class="form-group">
                        <label>기숙사</label>
                        <select name="studentRoom${studentRowCount}" onchange="updateStudentName(${studentRowCount})">
                            <option value="">선택</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>이름</label>
                        <select name="studentName${studentRowCount}" onchange="checkRowData(${studentRowCount})">
                            <option value="">선택</option>
                        </select>
                    </div>
                </div>
                
                <div class="student-grid">
                    <div class="form-group">
                        <label>상태</label>
                        <select name="studentStatus${studentRowCount}" onchange="checkRowData(${studentRowCount})">
                            <option value="">선택</option>
                            ${CONFIG.STATUS_TYPES.map(s => `<option value="${s}">${s}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>메모</label>
                        <input type="text" name="studentMemo${studentRowCount}" placeholder="메모" onchange="checkRowData(${studentRowCount})">
                    </div>
                </div>
            `;
            
            studentRows.appendChild(rowDiv);
        }

        function removeStudentRow(rowId) {
            const row = document.getElementById(`studentRow${rowId}`);
            if (row) {
                row.style.transform = 'scale(0)';
                row.style.opacity = '0';
                setTimeout(() => row.remove(), 300);
            }
        }

        function checkRowData(rowId) {
            const row = document.getElementById(`studentRow${rowId}`);
            const name = document.querySelector(`select[name="studentName${rowId}"]`).value;
            const status = document.querySelector(`select[name="studentStatus${rowId}"]`).value;
            
            if (name && status) {
                row.classList.add('has-data');
            } else {
                row.classList.remove('has-data');
            }
        }

        async function updateRoomOptions(rowId) {
            const buildingSelect = document.querySelector(`select[name="studentBuilding${rowId}"]`);
            const floorSelect = document.querySelector(`select[name="studentFloor${rowId}"]`);
            const roomSelect = document.querySelector(`select[name="studentRoom${rowId}"]`);
            
            const building = buildingSelect.value;
            const floor = floorSelect.value;
            
            roomSelect.innerHTML = '<option value="">선택</option>';
            
            if (building && floor) {
                try {
                    const rooms = generateRoomNumbers(building, floor);
                    rooms.forEach(room => {
                        const option = document.createElement('option');
                        option.value = room;
                        option.textContent = room;
                        roomSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('호실 옵션 업데이트 오류:', error);
                }
            }
        }

        function generateRoomNumbers(building, floor) {
            const range = CONFIG.ROOM_RANGES[building] && CONFIG.ROOM_RANGES[building][floor];
            if (!range) return [];
            
            const rooms = [];
            const isTripleRoom = CONFIG.TRIPLE_ROOMS && CONFIG.TRIPLE_ROOMS[building + floor];
            
            for (let i = range[0]; i <= range[1]; i++) {
                const roomNumber = building + i.toString();
                rooms.push(roomNumber);
            }
            
            console.log(`${building}동 ${floor}층 호실 생성: ${rooms.length}개 ${isTripleRoom ? '(3인실)' : '(1인실)'}`);
            return rooms;
        }

        async function updateStudentName(rowId) {
            const roomSelect = document.querySelector(`select[name="studentRoom${rowId}"]`);
            const nameSelect = document.querySelector(`select[name="studentName${rowId}"]`);
            
            const roomNumber = roomSelect.value;
            nameSelect.innerHTML = '<option value="">선택</option>';
            
            if (roomNumber) {
                try {
                    console.log(`${roomNumber} 호실의 학생 조회 중...`);
                    const students = await sheetsAPI.findStudentByRoom(roomNumber);
                    
                    if (students.length > 0) {
                        students.forEach(student => {
                            if (student.name.trim() !== '미배정' && student.name.trim() !== '') {
                                const option = document.createElement('option');
                                option.value = student.name;
                                option.textContent = student.name;
                                option.dataset.rowIndex = student.rowIndex;
                                nameSelect.appendChild(option);
                            }
                        });
                        
                        console.log(`${roomNumber}에서 ${students.length}명 발견`);
                        
                        if (nameSelect.children.length === 1) {
                            const option = document.createElement('option');
                            option.value = '';
                            option.textContent = '배정된 학생 없음';
                            option.disabled = true;
                            nameSelect.appendChild(option);
                        }
                    } else {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = '등록된 학생 없음';
                        option.disabled = true;
                        nameSelect.appendChild(option);
                    }
                } catch (error) {
                    console.error('학생 이름 조회 오류:', error);
                    showAlert('학생 정보를 불러오는 중 오류가 발생했습니다.', 'error');
                }
            }
        }

        function checkExistingReport() {
            const building = document.getElementById('building').value;
            const floor = document.getElementById('floor').value;
            
            if (building && floor) {
                const reportKey = `${Utils.getReportPeriodId()}_${building}_${floor}`;
                const modificationCheckbox = document.getElementById('modificationCheckbox');
                
                if (submittedReports.has(reportKey)) {
                    modificationCheckbox.style.display = 'block';
                    showAlert(`${building}동 ${floor}층에 대한 보고가 이미 제출되었습니다.`, 'warning');
                } else {
                    modificationCheckbox.style.display = 'none';
                    document.getElementById('isModification').checked = false;
                }
            }
        }

        function loadSubmittedReports() {
            const stored = localStorage.getItem('submittedReports');
            if (stored) {
                submittedReports = new Set(JSON.parse(stored));
            }
        }

        function saveSubmittedReport(reportKey) {
            submittedReports.add(reportKey);
            localStorage.setItem('submittedReports', JSON.stringify([...submittedReports]));
        }

        function saveReportData(reportData) {
            const reportDate = Utils.getReportPeriodId();
            const storedReports = JSON.parse(localStorage.getItem('dailyReports') || '{}');
            
            if (!storedReports[reportDate]) {
                storedReports[reportDate] = {};
            }
            
            const reportKey = `${reportData.building}_${reportData.floor}`;
            storedReports[reportDate][reportKey] = reportData;
            
            localStorage.setItem('dailyReports', JSON.stringify(storedReports));
        }

        // 리셋 모달 관련 함수들
        function showResetModal() {
            document.getElementById('resetModal').style.display = 'block';
            document.getElementById('resetPassword').value = '';
        }

        function closeResetModal() {
            document.getElementById('resetModal').style.display = 'none';
        }

        async function executeReset() {
            const password = document.getElementById('resetPassword').value;
            
            if (password !== CONFIG.RESET_PASSWORD) {
                showAlert('비밀번호가 올바르지 않습니다.', 'error');
                return;
            }
            
            if (!confirm('정말로 모든 학생의 상태 정보를 리셋하시겠습니까?')) {
                return;
            }
            
            try {
                showAlert('데이터 리셋 중...', 'info');
                await sheetsAPI.resetAllStatuses();
                showAlert('모든 학생 상태 정보가 성공적으로 리셋되었습니다.', 'success');
                closeResetModal();
            } catch (error) {
                console.error('리셋 오류:', error);
                showAlert('리셋 중 오류가 발생했습니다: ' + error.message, 'error');
            }
        }

        // 폼 제출 처리 (구글 시트 연동 강화)
        document.getElementById('reportForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!Utils.isValidReportTime()) {
                showAlert('보고 가능 시간이 아닙니다. (22:00 ~ 21:59)', 'error');
                return;
            }
            
            const formData = new FormData(this);
            const building = formData.get('building');
            const floor = formData.get('floor');
            const manager = formData.get('manager');
            const isModification = formData.get('isModification') === 'on';
            
            if (!building || !floor || !manager) {
                showAlert('담당자, 동, 층을 모두 선택해주세요.', 'error');
                return;
            }
            
            const reportKey = `${Utils.getReportPeriodId()}_${building}_${floor}`;
            
            // 기존 보고 확인
            if (submittedReports.has(reportKey) && !isModification) {
                showAlert('이미 해당 동/층에 대해 보고하셨습니다.', 'error');
                return;
            }
            
            // 개별 학생 정보 수집 및 유효성 검사
            const studentData = [];
            for (let i = 1; i <= studentRowCount; i++) {
                const rowElement = document.getElementById(`studentRow${i}`);
                if (!rowElement) continue;
                
                const building = formData.get(`studentBuilding${i}`);
                const floor = formData.get(`studentFloor${i}`);
                const room = formData.get(`studentRoom${i}`);
                const name = formData.get(`studentName${i}`);
                const status = formData.get(`studentStatus${i}`);
                const memo = formData.get(`studentMemo${i}`);
                
                if ((building || floor || room || name || status) && 
                    !(building && floor && room && name && status)) {
                    showAlert(`${i}번째 학생 정보가 불완전합니다.`, 'warning');
                    return;
                }
                
                if (building && floor && room && name && status && name.trim() !== '미배정') {
                    studentData.push({ name, status, room, memo: memo || '' });
                }
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            
            try {
                submitBtn.innerHTML = '<div class="spinner"></div> 처리 중...';
                
                await submitReport(formData, reportKey, isModification, studentData);
                
                submitBtn.innerHTML = '<i class="fas fa-check"></i> 완료!';
                showAlert(`인원보고가 성공적으로 ${isModification ? '수정' : '제출'}되었습니다.`, 'success');
                
                saveSubmittedReport(reportKey);
                
                setTimeout(() => {
                    this.reset();
                    studentRowCount = 0;
                    document.getElementById('studentRows').innerHTML = '';
                    document.getElementById('modificationCheckbox').style.display = 'none';
                    for (let i = 0; i < 2; i++) {
                        addStudentRow();
                    }
                    submitBtn.innerHTML = originalText;
                }, 2000);
                
            } catch (error) {
                console.error('제출 오류:', error);
                showAlert('제출 중 오류가 발생했습니다: ' + error.message, 'error');
                submitBtn.innerHTML = originalText;
            } finally {
                submitBtn.disabled = false;
            }
        });

        async function submitReport(formData, reportKey, isModification, studentData) {
            const reportData = {
                timestamp: Utils.getCurrentTimeString(),
                manager: formData.get('manager'),
                building: formData.get('building'),
                floor: formData.get('floor'),
                currentCount: parseInt(formData.get('currentCount')) || 0,
                overnight: parseInt(formData.get('overnight')) || 0,
                outing: parseInt(formData.get('outing')) || 0,
                checkout: parseInt(formData.get('checkout')) || 0,
                newStudent: parseInt(formData.get('newStudent')) || 0,
                moveIn: parseInt(formData.get('moveIn')) || 0,
                moveOut: parseInt(formData.get('moveOut')) || 0,
                etc: parseInt(formData.get('etc')) || 0,
                memo: formData.get('memo') || '',
                students: studentData,
                isModification: isModification
            };
            
            console.log('보고 데이터:', reportData);
            
            // 구글 시트에 학생 상태 업데이트
            await updateSheetsWithReport(reportData);
            
            // Jandi 알림 전송
            await sendJandiNotification(reportData);
        }

        async function updateSheetsWithReport(reportData) {
            console.log('=== 구글 시트 업데이트 시작 ===');
            console.log('업데이트할 학생 수:', reportData.students.length);
            console.log('보고 데이터:', reportData);
            
            if (reportData.students.length === 0) {
                console.log('개별 학생 정보가 없음. 집계 정보만 저장.');
                saveReportData(reportData);
                return;
            }
            
            // 개별 학생 상태 업데이트
            const updateResults = [];
            
            for (let i = 0; i < reportData.students.length; i++) {
                const student = reportData.students[i];
                console.log(`\n[${i+1}/${reportData.students.length}] ${student.name} 업데이트 시작`);
                console.log(`- 호실: ${student.room}`);
                console.log(`- 상태: ${student.status}`);
                console.log(`- 메모: ${student.memo || '없음'}`);
                
                try {
                    const result = await sheetsAPI.updateStudentStatus(student.name, student.status, student.memo);
                    updateResults.push({ 
                        success: true, 
                        student: student.name, 
                        result,
                        status: student.status 
                    });
                    console.log(`✓ ${student.name} 업데이트 성공:`, result);
                } catch (error) {
                    console.error(`✗ ${student.name} 업데이트 실패:`, error.message);
                    updateResults.push({ 
                        success: false, 
                        student: student.name, 
                        error: error.message,
                        status: student.status 
                    });
                }
                
                // 요청 간 딜레이 (API 제한 방지)
                if (i < reportData.students.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            // 결과 요약
            const successCount = updateResults.filter(r => r.success).length;
            const failCount = updateResults.filter(r => !r.success).length;
            
            console.log('\n=== 업데이트 결과 요약 ===');
            console.log(`성공: ${successCount}명, 실패: ${failCount}명`);
            
            if (successCount > 0) {
                console.log('성공한 업데이트:');
                updateResults.filter(r => r.success).forEach(r => {
                    console.log(`- ${r.student}: ${r.status}`);
                });
            }
            
            if (failCount > 0) {
                console.log('실패한 업데이트:');
                updateResults.filter(r => !r.success).forEach(r => {
                    console.log(`- ${r.student}: ${r.error}`);
                });
                
                const failedStudents = updateResults.filter(r => !r.success).map(r => r.student).join(', ');
                showAlert(`일부 학생 업데이트 실패: ${failedStudents}`, 'warning');
            }
            
            // 웹앱이 설정되지 않은 경우 안내
            if (failCount === reportData.students.length && CONFIG.WEBAPP_URL.includes('YOUR_WEBAPP_ID')) {
                showAlert('Google Apps Script 웹앱을 설정해주세요. 현재는 로컬에만 저장됩니다.', 'warning');
            }
            
            // 로컬 스토리지에 보고 데이터 저장
            saveReportData(reportData);
            
            console.log('=== 구글 시트 업데이트 완료 ===');
        }

        async function sendJandiNotification(reportData) {
            const message = createJandiMessage(reportData);
            
            try {
                const response = await fetch(CONFIG.JANDI_WEBHOOK, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        body: message,
                        connectColor: reportData.isModification ? '#FFA500' : '#4facfe'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Jandi 알림 전송 실패');
                }
                
                console.log('Jandi 알림 전송 완료');
            } catch (error) {
                console.error('Jandi 알림 오류:', error);
                // Jandi 오류는 전체 프로세스를 중단하지 않음
            }
        }

        function createJandiMessage(reportData) {
            const modificationText = reportData.isModification ? '[🔄 수정보고] ' : '';
            let message = `${modificationText}🏠 기숙사 인원보고\n\n`;
            message += `📅 ${reportData.timestamp}\n`;
            message += `👤 ${reportData.manager}\n`;
            message += `🏢 ${reportData.building}동 ${reportData.floor}층\n\n`;
            
            message += `📊 인원 현황:\n`;
            if (reportData.currentCount > 0) message += `👥 현재원: ${reportData.currentCount}명\n`;
            if (reportData.overnight > 0) message += `🌙 외박: ${reportData.overnight}명\n`;
            if (reportData.outing > 0) message += `🚶 외출: ${reportData.outing}명\n`;
            if (reportData.checkout > 0) message += `🚪 퇴소: ${reportData.checkout}명\n`;
            if (reportData.newStudent > 0) message += `🆕 신규: ${reportData.newStudent}명\n`;
            if (reportData.moveIn > 0) message += `➕ 이동(입): ${reportData.moveIn}명\n`;
            if (reportData.moveOut > 0) message += `➖ 이동(출): ${reportData.moveOut}명\n`;
            if (reportData.etc > 0) message += `❓ 기타: ${reportData.etc}명\n`;
            
            if (reportData.students.length > 0) {
                message += `\n👥 개별 학생 (${reportData.students.length}명):\n`;
                
                const groupedByStatus = {};
                reportData.students.forEach(student => {
                    if (!groupedByStatus[student.status]) {
                        groupedByStatus[student.status] = [];
                    }
                    groupedByStatus[student.status].push(student);
                });
                
                Object.entries(groupedByStatus).forEach(([status, students]) => {
                    const statusEmoji = {
                        '외박': '🌙', '외출': '🚶', '퇴소': '🚪',
                        '이동+': '➕', '이동-': '➖', '정상': '✅',
                        '신규': '🆕', '기타': '❓'
                    };
                    
                    message += `\n${statusEmoji[status] || '📝'} ${status} (${students.length}명):\n`;
                    students.forEach(student => {
                        message += `   • ${student.name} (${student.room})`;
                        if (student.memo && student.memo.trim()) {
                            message += ` - ${student.memo}`;
                        }
                        message += '\n';
                    });
                });
            }
            
            if (reportData.memo) {
                message += `\n📝 기타사항: ${reportData.memo}`;
            }
            
            return message;
        }

        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type}`;
            
            const iconMap = {
                'success': 'check-circle',
                'error': 'exclamation-circle',
                'warning': 'exclamation-triangle',
                'info': 'info-circle'
            };
            
            alertDiv.innerHTML = `
                <i class="fas fa-${iconMap[type] || 'info-circle'}"></i>
                ${message}
            `;
            
            alertContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.style.opacity = '0';
                    alertDiv.style.transform = 'translateY(-20px)';
                    setTimeout(() => alertDiv.parentNode.removeChild(alertDiv), 300);
                }
            }, 5000);
            
            alertDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // 모달 외부 클릭 시 닫기
        window.onclick = function(event) {
            const modal = document.getElementById('resetModal');
            if (event.target === modal) {
                closeResetModal();
            }
        }
    </script>
</body>
</html>
